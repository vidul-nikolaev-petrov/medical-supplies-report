<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="description" content="Лекарствени Отчети" />
        <meta name="author" content="Видул Николаев Петров" />
        <meta name="keywords" content="Отчет, Приход, Разход, Лекарства" />
        <meta name="version" content="1.0.5" />
        <title>Лекарствен Отчет</title>
        <script src="libs/js/rxjs.umd.min.js"></script>
        <script src="libs/js/numberToString.js"></script>
        <script src="libs/js/easepick.min.js"></script>
        <script src="libs/js/hystmodal.min.js"></script>
        <script src="libs/js/words2numbers.js"></script>
        <script src="libs/js/toastify.js"></script>
        <script src="libs/js/moment.js"></script>
        <link rel="stylesheet" type="text/css" href="libs/css/toastify.min.css" />
        <link rel="stylesheet" type="text/css" href="libs/css/hystmodal.min.css" />
        <link rel="icon" type="image/x-icon" href="img/logo.ico" />
        <style>
            body {
                font-size: medium;
                font-family: Verdana, Geneva, Tahoma, sans-serif;
                background-color: rgb(243, 243, 243);
                padding: 1% 8%;
                margin: 0;
                height: 100%;
                opacity: 0;
                transition: opacity 2s;
                -webkit-transition: opacity 2s;
            }

            .logo {
                position: fixed;
                top: 20px;
                left: 30px;
                width: 60px;
                height: auto;
                opacity: 1;
            }

            .speech {
                position: fixed;
                bottom: 20px;
                left: 30px;
                width: 40px;
                height: auto;
                border: 1px solid rgb(237, 237, 237);
                border-radius: 10px;
                opacity: 0.84;
            }

            table {
                border-collapse: collapse;
                width: 80%;
                margin: auto;
                table-layout: fixed;
            }

            th,
            td {
                /* border: 1px solid rgb(154, 153, 153); */
                border: none;
                padding: 0px;
                text-align: center;
                min-width: 100px;
            }

            th {
                padding: 8px;
                background-color: rgb(212, 208, 200);
            }

            tr:nth-child(even) {
                background-color: white;
            }

            tr:focus-within {
                background-color: rgb(215, 213, 213);
            }

            tr td:first-child {
                color: rgb(194, 194, 194);
                font-size: small;
            }

            table#results {
                margin-top: 11px;
                margin-bottom: 11px;
                font-size: 14px;
                font-weight: bold;
                background-color: rgb(212, 208, 200);
                border-radius: 10px;
            }

            table#results td {
                border: none;
                padding: 5px 0;
                min-width: 100px;
            }

            table#results td.left {
                text-align: left;
                padding-left: 11px;
            }
            table#results td.right {
                text-align: right;
                font-weight: lighter;
            }

            button {
                margin: 10px;
                padding: 10px;
            }

            p {
                font-weight: bold;
            }

            input[type="text"],
            input[type="number"] {
                border: 1px solid gray;
                padding: 5px;
                padding-left: 15px;
                font-size: medium;
                border-radius: 5px;
                box-sizing: border-box;
                width: 50%;
                color: #504f4f;
            }

            input[type="text"] {
                color: rgb(100, 100, 100);
                width: 90%;
            }

            input:focus {
                color: #282828;
                outline: none;
            }

            p#results {
                text-align: right;
            }

            span#result-quantity {
                display: none;
            }

            h1 {
                text-align: center;
            }

            button {
                padding: 2px;
                border: none;
                color: aliceblue;
            }

            div#buttons {
                text-align: center;
                /* position: fixed;
                top: 50%;
                left: -5px;
                transform: translate(0, -50%); */
            }

            div#buttons > button {
                text-align: center;
                background-color: rgb(72, 192, 72);
                padding: 8px 8px 8px 8px;
                font-size: medium;
                width: 100px;
                /* margin-left: 0; */
                /* display: block; */
                border-radius: 22px;
                transition: background-color 0.5s ease-in-out, color 0.1s ease-in-out;
            }

            div#buttons > button:hover {
                color: rgb(60, 60, 60);
                background-color: rgb(118, 253, 46);
            }

            span.th {
                text-align: center;
                font-size: small;
                display: inline-block;
                width: 45%;
            }

            span.outgo {
                text-align: center;
                font-size: small;
                display: inline-block;
                width: 40%;
            }

            .td-sum {
                font-family: Arial, Helvetica, sans-serif;
                font-size: 14px;
                font-weight: bold;
            }

            div#header {
                width: 100%;
                margin: 4% 0 4% 0;
                text-align: center;
            }
            div#header div#title {
                font-weight: bold;
                font-size: larger;
                color: #e7e4e4;
                text-shadow: 2px 2px 4px #000;
            }
            div#header div#body {
                font-size: smaller;
            }
            div#header div.header {
                margin-top: 10px;
            }
            div#header input {
                border: none;
                border-radius: 0;
                background: transparent;
                text-align: center;
                font-size: small;
            }
            div#header input#period-range {
                /* border-bottom: 1px solid rgb(75, 75, 75); */
                width: 13%;
                font-weight: bold;
            }
            div#header input#institution,
            div#header input#employee {
                font-size: normal;
                font-weight: bold;
                width: 30%;
                color: rgb(58, 57, 57);
            }
            input[type="number"]::-webkit-outer-spin-button,
            input[type="number"]::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            span.scroll {
                position: fixed;
                left: 33px;
                transform: translate(0, -50%);
                width: 20px;
                text-align: center;
                height: auto;
                border-radius: 8px;
                opacity: 0.84;
                padding: 4px 8px 6px 8px;
                font-size: 24px;
                opacity: 0.3;
                display: none;
                border: 1px solid rgb(223, 222, 222);
            }
            span.scroll:hover {
                border: 1px solid rgb(175, 175, 175);
            }
            #scroll-down {
                bottom: 60px;
            }
            #scroll-up {
                bottom: 110px;
            }
            #table-sort-down #table-sort-up {
                display: inline;
            }
        </style>
    </head>
    <body onload="document.body.style.opacity='1'">
        <span id="scroll-down" class="scroll">&#8650;</span>
        <span id="scroll-up" class="scroll">&#8648;</span>
        <div id="header">
            <div class="header" id="title">Приходно-разходен отчет за наличност на лекарствата</div>
            <div class="header" id="sub-title">
                <input type="text" id="employee" placeholder="Длъжност / Имена" />
                <input type="text" id="institution" placeholder="Учебно заведение" />
            </div>
            <div class="header" id="body">
                за период <input type="text" id="period-range" placeholder="липват данни" />
            </div>
        </div>
        <img src="img/logo.png" alt="Logo" class="logo" id="logo" data-hystmodal="#m-main" />
        <img src="img/mic.gif" alt="Speech" class="speech" id="speech" />
        <table id="table-items">
            <thead>
                <tr>
                    <th width="2%"></th>
                    <th width="38%" id="table-sort">
                        <span id="table-sort-up">&#8593;</span>
                        <span id="table-sort-down">&#8595;</span>
                        НАИМЕНОВАНИЕ
                    </th>
                    <th width="30%" colspan="2">
                        <div>ОСТАТЪК</div>
                        <div class="th">
                            <span class="th">Количество</span>
                            <span class="th">Единична цена</span>
                        </div>
                    </th>
                    <th width="10%">&#8721;</th>
                    <th width="20%" colspan="2">
                        <div>РАЗХОД</div>
                        <div class="th">
                            <span class="outgo">Количество</span>
                            <span class="outgo">&#8721;</span>
                        </div>
                    </th>
                    <th width=""></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <table id="results">
            <tr>
                <td class="right">
                    <span id="result-quantity">Общо количество: <span id="total-quantity"></span></span>
                    Общ остатък:
                </td>
                <td width="100px">
                    <span id="total-price"></span>
                </td>
                <td width="10px">/</td>
                <td class="" width="100px">
                    <span id="total-price-remainder"></span>
                </td>
                <td class="right">Общ разход:</td>
                <td class="left">
                    <span id="total-price-outgo"></span>
                </td>
            </tr>
        </table>
        <div id="buttons">
            <button id="add-row">Добави</button>
            <button id="remove-row">Премахни</button>
            <button id="save-items">Запази</button>
            <button id="import-items">Импорт</button>
            <button id="import-items-outer" style="display: none">Импорт</button>
            <button id="export-items" style="display: none">Експорт</button>
            <button id="finalize" style="display: none">Финализирай</button>
            <button id="print-items-r" style="display: block">Принт О</button>
            <button id="print-items-o" style="display: none">Принт Р</button>
            <input type="file" id="importFile" style="display: none" accept=".json" />
        </div>
        <div id="print"></div>
        <script>
            const { fromEvent } = rxjs;
            const { map, debounceTime } = rxjs.operators;
            let items = [],
                settings = {},
                table = document.getElementById("table-items"),
                tableSort = document.getElementById("table-sort"),
                totalQuantityEl = document.getElementById("total-quantity"),
                totalPriceEl = document.getElementById("total-price"),
                totalPriceRemainderEl = document.getElementById("total-price-remainder"),
                totalOutgoPriceEl = document.getElementById("total-price-outgo"),
                addBtn = document.getElementById("add-row"),
                removeBtn = document.getElementById("remove-row"),
                saveBtn = document.getElementById("save-items"),
                exportBtn = document.getElementById("export-items"),
                importBtn = document.getElementById("import-items"),
                importBtnOuter = document.getElementById("import-items-outer"),
                importFile = document.getElementById("importFile"),
                finalizeBtn = document.getElementById("finalize"),
                // print
                printBtnR = document.getElementById("print-items-r"),
                printBtnO = document.getElementById("print-items-o"),
                // settings
                employee = document.getElementById("employee"),
                institution = document.getElementById("institution"),
                peroidRange = document.getElementById("period-range"),
                // speech to text
                speechImg = document.getElementById("speech"),
                updateTotal = () => {
                    const totalQuantity = items.reduce((acc, item) => acc + item.quantity, 0),
                        totalPrice = items
                            .reduce((acc, item) => acc + item.price * item.quantity, 0)
                            .toFixed(2);
                    totalQuantityEl.textContent = totalQuantity;
                    totalPriceEl.textContent = totalPrice;
                    totalPriceRemainderEl.textContent = totalPriceRemainder();
                },
                updateOutgo = () => {
                    const totalPrice = items
                        .filter((e) => e.outgoQuantity)
                        .reduce((acc, item) => acc + item.outgoQuantity * item.price, 0)
                        .toFixed(2);
                    totalOutgoPriceEl.textContent = totalPrice;
                    totalPriceRemainderEl.textContent = totalPriceRemainder();
                };

            function updateSettings() {
                peroidRange.value = settings.peroidRange;
                employee.value = settings.employee || "";
                institution.value = settings.institution || "";
            }

            function totalPriceRemainder() {
                return (
                    items.reduce((acc, item) => acc + item.price * item.quantity, 0) -
                    items
                        .filter((e) => e.outgoQuantity)
                        .reduce((acc, item) => acc + item.outgoQuantity * item.price, 0)
                ).toFixed(2);
            }

            // updateTotal();
            // updateOutgo();

            const row$ = fromEvent(addBtn, "click").pipe(map(() => ({ name: "", quantity: "", price: "" }))),
                remove$ = fromEvent(removeBtn, "click"),
                localStoragePrefix = "MSR",
                localStorageName = `${localStoragePrefix}-current`,
                renderItemRow = (item) => {
                    const tr = document.createElement("tr"),
                        tdId = document.createElement("td"),
                        tdName = document.createElement("td"),
                        tdQuantity = document.createElement("td"),
                        tdPrice = document.createElement("td"),
                        tdAction = document.createElement("td"),
                        tdTotalPrice = document.createElement("td"),
                        tdOutgoQuantity = document.createElement("td"),
                        tdOutgoPrice = document.createElement("td"),
                        inputName = document.createElement("input"),
                        inputQuantity = document.createElement("input"),
                        inputPrice = document.createElement("input"),
                        inputOutgoQuantity = document.createElement("input"),
                        removeBtn = document.createElement("button"),
                        updateRowPrice = () => {
                            if (inputQuantity.value && inputPrice.value) {
                                tdTotalPrice.innerText = (
                                    parseInt(inputQuantity.value, 10) * parseFloat(inputPrice.value)
                                ).toFixed(2);
                            } else {
                                tdTotalPrice.innerText = "";
                            }
                            if (inputQuantity.value && inputPrice.value && inputOutgoQuantity.value) {
                                tdOutgoPrice.innerText = (
                                    parseInt(inputOutgoQuantity.value, 10) * parseFloat(inputPrice.value)
                                ).toFixed(2);
                            } else {
                                tdOutgoPrice.innerText = "";
                            }
                        };
                    tdId.innerText = table.getElementsByTagName("tr").length;
                    inputName.type = "text";
                    inputName.value = item.name;
                    inputName.addEventListener("input", () => {
                        item.name = inputName.value;
                    }),
                        inputName.addEventListener("focus", (e) => {
                            window.previouslyFocused = e.target;
                        });
                    tdName.appendChild(inputName);
                    inputQuantity.type = "number";
                    inputQuantity.min = "0";
                    inputQuantity.step = "1";
                    inputQuantity.value = item.quantity;
                    inputQuantity.addEventListener("input", () => {
                        if (!inputQuantity.validity.valid) {
                            inputQuantity.value = "";
                        }
                        const val = parseInt(inputQuantity.value, 10);
                        const valOutgo = parseInt(inputOutgoQuantity.value, 10);
                        if (!Number.isNaN(val)) {
                            item.quantity = val;
                            inputPrice.disabled = false;
                        } else {
                            item.quantity = "";
                            inputPrice.disabled = true;
                        }
                        if (val < valOutgo) showToast("Наличността е по-малка от разхода!");
                        updateRowPrice();
                        updateTotal();
                    });
                    tdQuantity.appendChild(inputQuantity);
                    inputPrice.type = "number";
                    inputPrice.min = "0";
                    inputPrice.step = "0.01";
                    inputPrice.value = item.price;
                    inputPrice.disabled = true;
                    inputPrice.addEventListener("input", () => {
                        if (!inputPrice.validity.valid) {
                            inputPrice.value = "";
                        }
                        const val = parseFloat(inputPrice.value);
                        if (!Number.isNaN(val)) {
                            item.price = val;
                            inputOutgoQuantity.disabled = false;
                        } else {
                            item.price = "";
                            inputOutgoQuantity.disabled = true;
                        }
                        updateRowPrice();
                        updateTotal();
                        updateOutgo();
                    });
                    inputOutgoQuantity.type = "number";
                    inputOutgoQuantity.min = "0";
                    inputOutgoQuantity.step = "1";
                    inputOutgoQuantity.value = item.outgoQuantity;
                    inputOutgoQuantity.disabled = true;
                    inputOutgoQuantity.addEventListener("input", () => {
                        if (!inputOutgoQuantity.validity.valid) {
                            inputOutgoQuantity.value = "";
                        }
                        const val = parseInt(inputOutgoQuantity.value, 10);
                        const valRemainder = parseInt(inputQuantity.value, 10);
                        if (Number.isNaN(val)) {
                            item.outgoQuantity = 0;
                        } else {
                            item.outgoQuantity = val;
                        }
                        if (val > valRemainder) showToast("Разходът надвишава наличността!");
                        updateRowPrice();
                        updateOutgo();
                    });
                    tdPrice.appendChild(inputPrice);
                    removeBtn.innerHTML = "&#10060;";
                    removeBtn.className = "remove-row";
                    removeBtn.addEventListener("click", () => {
                        items = items.filter((i) => i !== item);
                        updateTotal();
                        updateOutgo();
                        tr.remove();
                        table.querySelectorAll("tr").forEach((e, i) => {
                            e.querySelector("td") && (e.querySelector("td").innerText = i);
                        });
                    });
                    tdOutgoQuantity.appendChild(inputOutgoQuantity);
                    tdAction.appendChild(removeBtn);
                    tr.appendChild(tdId);
                    tr.appendChild(tdName);
                    tr.appendChild(tdQuantity);
                    tr.appendChild(tdPrice);
                    tr.appendChild(tdTotalPrice);
                    tr.appendChild(tdOutgoQuantity);
                    tr.appendChild(tdOutgoPrice);
                    tr.appendChild(tdAction);
                    table.querySelector("tbody").appendChild(tr);
                    // some CSS enhancements:
                    tdTotalPrice.className = "td-sum";
                    tdOutgoPrice.className = "td-sum";
                    if (!inputName.value) {
                        inputName.focus();
                    }
                    return {
                        name: inputName,
                        quantity: inputQuantity,
                        outgoQuantity: inputOutgoQuantity,
                        price: inputPrice,
                    };
                };

            row$.subscribe((item) => {
                items = [...items, item];
                renderItemRow(item);
                updateTotal();
                updateOutgo();
            });

            remove$.subscribe(() => {
                if (items.length) {
                    const item = items.pop();
                    updateTotal();
                    updateOutgo();
                    table.querySelector("tbody tr:last-child").remove();
                }
            });

            function printer() {
                const html = {
                    css: `
                        <style>
                            @page { size: auto; margin-top: 8mm; margin-bottom: 10mm; }
                            body { -webkit-print-color-adjust: exact; }
                            div#title { padding-top: 5%; text-align: center; }
                            div.center { padding-top: 2%; text-align: center; }
                            table { border-collapse: collapse; width: 80%; margin: auto; font-size:16px; }
                            th, td { border: 1px solid black; padding: 4px; text-align: center; }
                            th { background-color: #CDCDCD; }
                            td.nobr { border-right: 0; }
                            td.nobl { border-left: 0; }
                            td.bold { font-weight: bold; }
                            tr#footer { background-color: #CCC; }
                            tr#subheader { background-color: white; }
                            tr:nth-child(even) { background: #F9F9F9; }
                            tr.page-break { border: 0; background: white !important; }
                            tr.page-break td { border: 0; }
                            div.footer { display: block; clear: both; margin: 10% 15%; font-size: 13px; }
                            div.total-price { text-align: center; }
                            span.left { float: left; }
                            span.right { float: right; }
                        </style>`,
                };

                function remainder() {
                    const body = items
                        .filter((e) => e.quantity > e.outgoQuantity)
                        .map((item) => [
                            item.name,
                            item.price,
                            item.quantity - item.outgoQuantity,
                            ((item.quantity - item.outgoQuantity) * item.price).toFixed(2),
                        ]);
                    const totalPriceOutgo = items
                        .reduce((acc, item) => acc + item.price * item.outgoQuantity, 0)
                        .toFixed(2);
                    let totalPrice = items
                        .reduce((acc, item) => acc + item.price * item.quantity, 0)
                        .toFixed(2);

                    totalPrice = (totalPrice - totalPriceOutgo).toFixed(2);

                    _printer({
                        body,
                        settings,
                        totalPrice,
                        htmlTitle: "ОПИС",
                        htmlFooter: "ОСТАТЪК",
                    });
                }

                function outgo() {
                    const body = items
                        .filter((e) => e.outgoQuantity)
                        .map((item) => [
                            item.name,
                            item.price,
                            item.outgoQuantity,
                            (item.outgoQuantity * item.price).toFixed(2),
                        ]);
                    const totalPrice = items
                        .reduce((acc, item) => acc + item.price * item.outgoQuantity, 0)
                        .toFixed(2);

                    _printer({
                        body,
                        settings,
                        totalPrice,
                        htmlTitle: "РАЗХОД",
                        htmlFooter: "РАЗХОД",
                    });
                }

                function _printer({ htmlTitle, htmlFooter, body, settings, totalPrice }) {
                    const w = window.open("", "PRINT");
                    const wadd = (str) => w.document.write(str);

                    wadd(`<html>`);
                    wadd(`
                        <head>
                            <title></title>
                            ${html.css}
                        </head>
                    `);
                    wadd(
                        `
                        <body>
                            <h3><div id="title">${settings.institution}</div><h3>
                            <h3><div class="center">${htmlTitle} НА МЕДИКАМЕНТИТЕ В СПЕШЕН ШКАФ</div><h3>
                            <h5><div class="center">за период:&nbsp;&nbsp;${settings.peroidRange}</div></h5>
                            <div class="center">&nbsp;</div>
                            <table>
                                <tr>
                                    <th colspan="2">Наименование</th>
                                    <th>Единична цена</th>
                                    <th colspan="2">Остатък</th>
                                </tr>
                                <tr id="subheader">
                                    <td class="nobr"></td>
                                    <td class="nobl"></td>
                                    <td></td>
                                    <td>Количество</td>
                                    <td>Сума</td>
                                </tr>`
                    );
                    let row;
                    for (let e = 1; e < body.length; e++) {
                        // invoke jump to the next page
                        if (e < 30 && !(e % 28)) { // 1st page
                            row = body[e];
                            for (let i = 0; i <= 2; i++) {
                                wadd(`
                                    <tr class="page-break" colspan="5">
                                        <td>blank</td>
                                    </tr>
                                `);
                            }
                        } else if (e > 32 && !(e % 32)) {
                            row = body[e];
                            for (let i = 0; i <= 2  ; i++) {
                                wadd(`
                                    <tr class="page-break" colspan="5">
                                        <td>blank</td>
                                    </tr>
                                `);
                            }
                        } else {
                            if (row) {
                                wadd(`
                                    <tr>
                                        <td>${e - 1}</td>
                                        <td>${row[0]}</td>
                                        <td>${row[1]}</td>
                                        <td>${row[2]}</td>
                                        <td>${row[3]}</td>
                                    </tr>
                                `);
                                row = undefined;
                            }
                            wadd(`
                                <tr>
                                    <td>${e}</td>
                                    <td>${body[e][0]}</td>
                                    <td>${body[e][1]}</td>
                                    <td>${body[e][2]}</td>
                                    <td>${body[e][3]}</td>
                                </tr>
                            `);
                        }
                    }
                    wadd(`
                            <tr id="footer">
                                <td class="nobr"></td>
                                <td class="nobr nobl"></td>
                                <td class="nobr nobl"></td>
                                <td class="nobr nobl bold">Общо:</td>
                                <td class="nobl bold">${totalPrice}</td>
                            </tr>
                    `);
                    wadd(`</table>`);

                    wadd(`
                        <div class="footer total-price">
                            ${htmlFooter}: ${totalPrice} / ${numberToWord(totalPrice)} /
                        </div>
                        <div class="footer">
                            <span class="left">${dateNow()}</span>
                            <span class="right">${settings.employee || "Длъжност / Имена"}</span>
                        </div>
                    `);
                    wadd(`</body></html>`);

                    w.document.close(); // necessary for IE >= 10
                    w.focus(); // necessary for IE >= 10*/

                    w.print();
                    w.close();

                    function dateNow() {
                        return moment().format("DD.MM.YYYY г.");
                    }

                    return true;
                }

                function numberToWord(number) {
                    const res = numberToString.convert(number);

                    return `${res.convertedInteger} ${res.integerCurrency} и
                            ${res.convertedFractional}  ${res.fractionalCurrency}`;
                }

                printer.printRemainder = remainder;
                printer.printOutgo = outgo;
            }

            // Invoke outer function to attach inner function
            printer();

            function exportItems() {
                saveToLocalStorage();

                const regex = new RegExp(`^${localStoragePrefix}`);
                const datetime = moment().format("DD.MM.YYYY-HH.mm.ss");
                const exportedData = {};

                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (regex.test(key)) {
                        exportedData[key] = localStorage.getItem(key);
                    }
                }

                const exportedDataJson = JSON.stringify(exportedData);
                const blob = new Blob([exportedDataJson], { type: "application/json" });
                const link = document.createElement("a");

                link.href = URL.createObjectURL(blob);
                link.download = `${localStoragePrefix}-${datetime}.json`;
                link.style.visibility = "hidden";

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function saveToLocalStorage() {
                localStorage.setItem(localStorageName, JSON.stringify({ items, settings }));
            }

            function importItemsFromLocalStorage() {
                const storage = JSON.parse(localStorage.getItem(localStorageName));
                if (!storage) return;
                items = storage.items;
                settings = storage.settings;
                items.forEach((i) => {
                    const inputs = renderItemRow(i);
                    for (const property in inputs) {
                        inputs[property].value = i[property];
                        inputs[property].dispatchEvent(new Event("input"));
                    }
                });
                updateTotal();
                updateOutgo();
                updateSettings();
            }

            function showToast(str) {
                Toastify({
                    text: str,
                    duration: 3000,
                    style: {
                        background: "linear-gradient(to right, #1195fa, #11e3fa)",
                    },
                }).showToast();
            }

            function showToastError(str) {
                Toastify({
                    text: str,
                    duration: 2000,
                    style: {
                        background: "linear-gradient(to right, orange, red)",
                    },
                }).showToast();
            }

            function clearTableRecords() {
                document.querySelectorAll(".remove-row").forEach((e) => e.click());
            }

            fromEvent(tableSort, "click").subscribe((e) => {
                let tmp = JSON.parse(JSON.stringify(items));
                const sortUp = document.getElementById("table-sort-up");
                const sortDown = document.getElementById("table-sort-down");
                const displayValDown = getDisplayVal(sortDown);
                const displayValUp = getDisplayVal(sortUp);

                if (displayValDown === displayValUp) {
                    sort({ down: true });
                    sortUp.style.display = "none";
                } else if (displayValUp === "none") {
                    sort({ up: true });
                    sortUp.style.display = "inline";
                    sortDown.style.display = "none";
                } else if (displayValDown === "none") {
                    sort({ down: true });
                    sortDown.style.display = "inline";
                    sortUp.style.display = "none";
                }

                clearTableRecords();

                items = tmp;
                items.forEach((e) => {
                    const inputs = renderItemRow(e);
                    for (const property in inputs) {
                        inputs[property].value = e[property];
                        inputs[property].dispatchEvent(new Event("input"));
                    }
                });

                updateTotal();
                updateOutgo();

                function sort({ down, up }) {
                    if (up) {
                        tmp.sort((a, b) => b.name.localeCompare(a.name));
                    } else {
                        tmp.sort((a, b) => a.name.localeCompare(b.name));
                    }
                }

                function getDisplayVal(el) {
                    return window.getComputedStyle(el).getPropertyValue("display");
                }
            });

            fromEvent(exportBtn, "click").subscribe(() => exportItems());

            fromEvent(saveBtn, "click").subscribe(() => {
                saveToLocalStorage();
                showToast("Успешен запис в локалното хранилище.");
            });

            fromEvent(importBtn, "click").subscribe(() => {
                importItemsFromLocalStorage();
                importBtn.style.display = "none";
                if (items.length > 0) {
                    showToast("Успешен импорт на локалните данни.");
                } else {
                    showToast("Няма намерени локални данни.");
                }
            });

            fromEvent(importBtnOuter, "click").subscribe(() => {
                importFile.value = null;
                importFile.click();
            });

            fromEvent(importFile, "change").subscribe(() => {
                if (importFile.files.length > 0) {
                    const reader = new FileReader();

                    reader.onload = () => {
                        const data = JSON.parse(reader.result);

                        // clear the table
                        clearTableRecords();

                        for (const key in data) {
                            localStorage.setItem(key, data[key]);
                        }

                        importItemsFromLocalStorage();

                        showToast("Външните данни бяха импортирани успешно.");
                    };

                    reader.readAsText(importFile.files[0]);
                }
            });

            fromEvent(finalizeBtn, "click").subscribe(() => {
                saveToLocalStorage();

                const regex = new RegExp(`^${localStoragePrefix}`);
                const datetime = moment().format("DD.MM.YYYY-HH.mm.ss");
                const itemCurrent = `${localStorageName}`;
                const itemArchived = `${localStoragePrefix}-${datetime}`;
                const data = {};

                for (let key in localStorage) {
                    if (regex.test(key)) {
                        data[key] = JSON.parse(localStorage.getItem(key));
                        localStorage.removeItem(key);
                    }
                }

                data[itemArchived] = JSON.parse(JSON.stringify(data[itemCurrent]));
                data[itemCurrent].items = [];
                data[itemCurrent].settings.peroidRange = "";
                data[itemArchived].items
                    .filter((e) => e.quantity > e.outgoQuantity)
                    .forEach((e) => {
                        data[itemCurrent].items.push({
                            name: e.name,
                            quantity: e.quantity - e.outgoQuantity,
                            price: e.price,
                            outgoQuantity: 0,
                        });
                    });

                for (let key in data) {
                    localStorage.setItem(key, JSON.stringify(data[key]));
                }

                clearTableRecords();
                importItemsFromLocalStorage();
                showToast("Отчетът беше финализиран успешно.");
            });

            fromEvent(printBtnR, "click").subscribe(() => {
                saveToLocalStorage();
                printer.printRemainder();
            });

            fromEvent(printBtnO, "click").subscribe(() => {
                saveToLocalStorage();
                printer.printOutgo();
            });

            fromEvent(peroidRange, "input").subscribe(() => {
                settings.peroidRange = peroidRange.value;
                saveToLocalStorage();
                showToast("Успешен запис на отчетния период в локалното хранилище.");
            });

            fromEvent(institution, "input")
                .pipe(debounceTime(5000))
                .subscribe(() => {
                    settings.institution = institution.value;
                    saveToLocalStorage();
                    showToast("Успешен запис на заведението в локалното хранилище.");
                });

            fromEvent(employee, "input")
                .pipe(debounceTime(5000))
                .subscribe(() => {
                    settings.employee = employee.value;
                    saveToLocalStorage();
                    showToast("Успешен запис на служителя в локалното хранилище.");
                });

            importBtn.click();

            const picker = new easepick.create({
                element: peroidRange,
                css: ["https://cdn.jsdelivr.net/npm/@easepick/bundle@1.2.1/dist/index.css"],
                plugins: ["RangePlugin"],
                lang: "bg-BG",
                RangePlugin: {
                    tooltipNumber(num) {
                        return num - 1;
                    },
                    locale: {
                        one: "ден",
                        other: "дена",
                    },
                },
                setup(picker) {
                    picker.on("select", () => {
                        peroidRange.dispatchEvent(new Event("input"));
                    });
                },
            });

            // document.querySelectorAll("input").forEach((e) => {
            //     e.addEventListener("focus", (e) => {
            //         window.previouslyFocused = e.target;
            //     });
            // });

            fromEvent(speechImg, "click").subscribe(() => {
                speech.init();

                // if (window.previouslyFocused) {
                //     window.previouslyFocused.focus();
                // }
            });

            function speech() {
                if (!("webkitSpeechRecognition" in window)) {
                    speechImg.style.display = "none";
                    return;
                }

                const recognition = new webkitSpeechRecognition();

                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = "bg-BG";

                let recording = false;

                const commands = {
                    addR: "добави (запис|ред)",
                    remR: "(изтрий|премахни) (запис|ред)",
                    remRN: "(изтрий|премахни) (номер )?(?!номер)\\S+",
                    save: "(запази|съхрани) (промяна|промени)",
                    export: "(направи експорт|запази хранилище)",
                    printR: "(принтирай|отпечатай) остатък",
                    printO: "(принтирай|отпечатай) разход",
                    end: "(край на|спри) (диктовка|запис)",
                    counter: 0,
                };

                const commandsReg = new RegExp(Object.values(commands).filter(isNaN).join("|"));

                function init() {
                    if (recording) {
                        stop();
                    } else {
                        start();
                    }
                }

                function start() {
                    recording = true;
                    recognition.start();
                    recognition.onresult = function (event) {
                        let interimResultTimeout;

                        clearTimeout(interimResultTimeout);

                        interimResultTimeout = setTimeout(() => {
                            processResults();
                        }, 512);

                        function processResults() {
                            const element = document.activeElement;
                            const resultsLength = event.results.length - 1;
                            const arrLength = event.results[resultsLength].length - 1;
                            const result = event.results[resultsLength][0].transcript.trim();

                            if (commandsReg.test(result)) {
                                commands.counter++;
                                if (commands.counter > 1) {
                                    setTimeout(() => (commands.counter = 0), 1000);
                                    return;
                                }
                            }

                            if (resultIn(commands.end)) {
                                stop();
                                element.value = "";
                                return;
                            }

                            if (resultIn(commands.addR)) {
                                addBtn.click();
                                return;
                            }

                            if (resultIn(commands.remR)) {
                                removeBtn.click();
                                return;
                            }

                            if (resultIn(commands.remRN)) {
                                removeRowN(result);
                                return;
                            }

                            if (resultIn(commands.save)) {
                                element.blur();
                                saveBtn.click();
                                return;
                            }

                            if (resultIn(commands.export)) {
                                exportBtn.click();
                                return;
                            }

                            if (resultIn(commands.printR)) {
                                command = true;
                                printBtnR.click();
                                return;
                            }

                            if (resultIn(commands.printO)) {
                                command = true;
                                printBtnO.click();
                                return;
                            }

                            command = false;

                            if (element.type === "text") {
                                element.value = result.charAt(0).toUpperCase() + result.slice(1);
                            } else {
                                element.value = result;
                            }

                            element.dispatchEvent(new Event("input"));

                            function resultIn(command) {
                                return new RegExp(command).test(result);
                            }

                            function removeRowN(result) {
                                console.log(">", result);

                                if (new RegExp(/\s+\d+$/).test(result)) {
                                    result = result.split(" ").at(-1);
                                } else {
                                    result = words2numbers(result);
                                }

                                console.log("<", result);

                                try {
                                    table
                                        .querySelector("tbody")
                                        .querySelector(`tr:nth-of-type(${result})`)
                                        .querySelector("button")
                                        .click();
                                    showToast(`Записът №${result} беше изтрит.`);
                                } catch (e) {
                                    showToastError(`Записът №${result} липса.`);
                                }
                            }
                        }
                    };

                    recognition.onerror = (event) => {
                        showToastError("Неразпознато число.");
                    };

                    speechImg.style.border = "1px solid red";
                }

                function stop() {
                    recording = false;
                    recognition.stop();
                    speechImg.style.border = "1px solid rgb(237, 237, 237)";
                }

                speech.init = init;
                speech.commands = commands;
            }

            document.addEventListener("keydown", function (event) {
                if (event.ctrlKey && event.keyCode === 76) {
                    event.preventDefault();
                    speechImg.click();
                }
            });

            speech();

            const modal = new HystModal({
                linkAttributeName: "data-hystmodal",
            });

            function setPageVersion(id) {
                const v = document.querySelector('meta[name="version"]').getAttribute("content");
                const el = document.getElementById(id);
                el.innerText = v;
            }

            // scroll navi
            (function () {
                const scrollUpButton = document.getElementById("scroll-up");
                const scrollDownButton = document.getElementById("scroll-down");
                const scrollPosition = window.pageYOffset;
                const windowHeight = window.innerHeight;
                const fullHeight = document.body.scrollHeight;
                const distanceToBottom = fullHeight - windowHeight - scrollPosition;

                if (scrollPosition > windowHeight) {
                    scrollUpButton.style.display = "block";
                }

                if (distanceToBottom > windowHeight) {
                    scrollDownButton.style.display = "block";
                }

                window.addEventListener("scroll", () => {
                    const scrollPosition = window.pageYOffset;
                    const windowHeight = window.innerHeight;
                    const fullHeight = document.body.scrollHeight;
                    const distanceToBottom = fullHeight - windowHeight - scrollPosition;

                    // Show or hide scroll up button
                    if (scrollPosition > windowHeight) {
                        scrollUpButton.style.display = "block";
                    } else {
                        scrollUpButton.style.display = "none";
                    }

                    // Show or hide scroll down button
                    if (distanceToBottom > windowHeight) {
                        scrollDownButton.style.display = "block";
                    } else {
                        scrollDownButton.style.display = "none";
                    }
                });

                scrollUpButton.addEventListener("click", () => {
                    window.scrollTo({
                        top: 0,
                        behavior: "smooth",
                    });
                });

                scrollDownButton.addEventListener("click", () => {
                    window.scrollTo({
                        top: document.body.scrollHeight,
                        behavior: "smooth",
                    });
                });
            })();
        </script>
        <style>
            div.hystmodal__window {
                padding: 0px;
                width: 33%;
            }
            button.hystmodal__close {
                margin: 0px;
            }
            button.hystmodal__close:focus {
                outline: none !important;
                outline-offset: none !important;
            }
            div.hystmodal__window div.modal-body {
                padding: 4%;
            }
            div.hystmodal__window div.link {
                color: rgb(109, 109, 109) !important;
                margin-left: 4%;
                padding: 3%;
            }
            div.hystmodal__window div.short {
                margin-left: 4%;
                padding: 1%;
            }
            div.hystmodal__window span.link {
                color: rgb(89, 89, 89) !important;
                padding: 15px 32px;
                text-decoration: none;
                font-size: 16px;
                font-style: normal;
                margin: 4px 2px;
            }
            div.hystmodal__window span.link:hover:before {
                content: "✓";
                width: 10px;
            }
            div.hystmodal__window span.link:before {
                content: "•";
                display: inline-block;
                width: 10px;
            }
            div.hystmodal__window span.link:hover {
                cursor: grab;
            }
            div.modal-header {
                text-align: center;
                color: #dfdfdf;
                background-color: #3a3939;
                font-size: large;
                padding: 5px;
            }
            div.modal-body {
                padding: 4%;
            }
        </style>
        <div class="hystmodal" id="m-main" aria-hidden="true">
            <div class="hystmodal__wrap">
                <div class="hystmodal__window" role="dialog" aria-modal="true">
                    <button data-hystclose class="hystmodal__close">Затовори</button>
                    <div class="modal-header">Основно меню</div>
                    <div class="modal-body">
                        <p>
                            <span class="link" onclick="modal.close(); modal.open('#m-print')">
                                Принтирай отчет
                            </span>
                        </p>
                        <p>
                            <span class="link" onclick="modal.close(); modal.open('#m-import-export')">
                                Импорт и Експорт
                            </span>
                        </p>
                        <p>
                            <span class="link" onclick="modal.close(); modal.open('#m-finalize')">
                                Финализирай отчета
                            </span>
                        </p>
                        <p>
                            <span
                                class="link"
                                onclick="modal.close(); modal.open('#m-about'); setPageVersion('about-version');"
                            >
                                Относно програмата
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <div class="hystmodal" id="m-print" aria-hidden="true">
            <div class="hystmodal__wrap">
                <div class="hystmodal__window" role="dialog" aria-modal="true">
                    <button data-hystclose class="hystmodal__close">Затовори</button>
                    <div class="modal-header">Принтиране на отчетите</div>
                    <div class="modal-body">
                        <div class="link">Обяснение кое-как.....</div>
                        <p>
                            <span class="link" onclick="modal.close(); printBtnR.click();">
                                Принтирай отчет за остатъка
                            </span>
                        </p>
                        <p>
                            <span class="link" onclick="modal.close(); printBtnO.click();">
                                Принтирай отчет за разхода
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <div class="hystmodal" id="m-import-export" aria-hidden="true">
            <div class="hystmodal__wrap">
                <div class="hystmodal__window" role="dialog" aria-modal="true">
                    <button data-hystclose class="hystmodal__close">Затовори</button>
                    <div class="modal-header">Управления на архива</div>
                    <div class="modal-body">
                        <div class="link">Обяснение кое-как.....</div>
                        <p>
                            <span class="link" onclick="modal.close(); importBtnOuter.click();">
                                Импортиране на файл с отчетите
                            </span>
                        </p>
                        <p>
                            <span class="link" onclick="modal.close(); exportBtn.click();">
                                Експортиране на отчетите във файл
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <div class="hystmodal" id="m-finalize" aria-hidden="true">
            <div class="hystmodal__wrap">
                <div class="hystmodal__window" role="dialog" aria-modal="true">
                    <button data-hystclose class="hystmodal__close">Затовори</button>
                    <div class="modal-header">Финализиране на отчета</div>
                    <div class="link">Обяснение кое-как.....</div>
                    <p>
                        <span class="link center" onclick="modal.close(); finalizeBtn.click();">
                            Финализирай отчета
                        </span>
                    </p>
                </div>
            </div>
        </div>
        <div class="hystmodal" id="m-about" aria-hidden="true">
            <div class="hystmodal__wrap">
                <div class="hystmodal__window" role="dialog" aria-modal="true">
                    <button data-hystclose class="hystmodal__close">Затовори</button>
                    <div class="modal-header">Относно MSR</div>
                    <div class="modal-body">
                        <div class="link short">• версия: <b id="about-version"></b></div>
                        <div class="link short">• лиценз: <b>GPLv3</b></div>
                        <div class="link short">• автор: <b>Видул Петров</b></div>
                        <div class="link short">• съавтор: <b>Теодора Монева</b></div>
                        <div class="link short">
                            • гласови команди (<i>Ctrl+L</i>):
                            <ul id="voice-commands">
                                <script>
                                    const ul = document.getElementById("voice-commands");
                                    ul.style.margin = "5px";
                                    Object.values(speech.commands)
                                        .filter(isNaN)
                                        .forEach((e) => {
                                            const li = document.createElement("li");
                                            li.textContent = e;
                                            li.style.fontStyle = "italic";
                                            li.style.fontSize = "small";
                                            ul.appendChild(li);
                                        });
                                </script>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
